# 图片存储迁移指南

本文档提供将应用中的图片元数据从localStorage迁移到数据库（或清理现有图片）的指导。

## 背景

应用之前使用浏览器的localStorage存储图片元数据，实际图片文件存储在阿里云OSS中。现在我们将图片元数据迁移到PostgreSQL数据库中，以实现更好的数据持久性和跨设备访问能力。

## 方案选择

有两种方案可供选择：

1. **数据迁移**：保留现有图片，将元数据从localStorage迁移到数据库
2. **数据清理**：清除localStorage和OSS中的所有现有图片，从头开始

## 方案1：数据迁移

### 准备工作

1. 确保应用部署了最新版本，包含以下文件：
   - API路由: `/app/api/admin/migrate-image/route.ts`
   - 迁移脚本: `/scripts/migrate-localstorage-images.js`

2. 数据库已完成迁移，创建了`UploadedImage`表

### 迁移步骤

1. **确保您已选择系统**：
   - 在顶部导航栏选择一个系统
   - 系统ID会自动保存在浏览器存储中

2. **在任意页面打开浏览器控制台**：
   - 打开浏览器开发者工具（F12或右键-检查）
   - 切换到Console(控制台)标签

3. **复制并运行迁移脚本**：
   - 打开`/scripts/migrate-localstorage-images.js`文件
   - 复制全部内容
   - 粘贴到控制台并按回车

4. **观察迁移结果**：
   - 脚本将从Zustand存储中获取当前系统ID
   - 逐个处理localStorage中的图片元数据
   - 显示迁移进度和结果
   - 成功后，将提示可以清除localStorage

5. **清除localStorage（可选）**：
   - 如果所有图片迁移成功，可以执行以下命令清除localStorage：
     ```javascript
     localStorage.removeItem("uploaded-image-files")
     ```

6. **刷新页面**：
   - 刷新页面以确认图片列表能够从数据库正确加载

### 注意事项

- 迁移脚本会自动从localStorage中的system-storage获取系统ID
- 迁移过程中请勿关闭页面或浏览器
- 如果迁移部分失败，可以修复问题后再次运行脚本（已成功的项目不会重复迁移）

## 方案2：清除现有图片

如果决定清除现有图片数据，可以使用清理脚本。

### 清理步骤

1. **确保您已选择系统**：
   - 在顶部导航栏选择一个系统

2. **在任意页面打开浏览器控制台**

3. **复制并运行清理脚本**：
   - 打开`/scripts/clear-image-storage.js`文件
   - 复制全部内容
   - 粘贴到控制台并按回车

4. **确认清除操作**：
   - 脚本会显示要删除的图片列表
   - 在确认对话框中选择"确定"继续清除

5. **观察清除结果**：
   - 脚本将自动从system-storage获取系统ID
   - 逐个从OSS删除图片并清理数据库记录
   - 最后清除localStorage中的图片元数据
   - 显示清除进度和结果

6. **刷新页面**：
   - 刷新页面以确认图片列表已被清空

### 注意事项

- 清除操作**不可逆**，请谨慎操作
- 确保您有足够的权限删除OSS中的图片
- 如果删除过程中出错，脚本仍会清除localStorage数据

## 故障排除

1. **系统ID获取失败**：
   - 错误信息：`未找到系统存储数据` 或 `未找到选中的系统ID`
   - 解决方案：
     - 确保您已登录并在页面顶部选择了一个系统
     - 刷新页面后再尝试运行脚本
     - 检查localStorage中是否有`system-storage`项

2. **API请求失败**：
   - 检查浏览器网络请求日志
   - 确保API路由正确部署

3. **OSS删除失败**：
   - 检查OSS访问权限
   - 验证图片在OSS中是否存在

4. **从其他设备迁移**：
   - 如果您在新设备上没有localStorage数据，请联系管理员获取迁移脚本的备用版本

如需更多帮助，请联系开发团队。 